<!DOCTYPE html>
<html>
  <head>
    <title>Buildless demo</title>
    <script type="module">
      import { render, useState, useEffect, html, css } from 'https://unpkg.com/@fordi-org/buildless';
      const theme = {
        background: '#333',
        backgroundVariant: '#222',
        primary: '#EEE',
        primaryVariant: '#FFF',
        secondary: '#2cf',
        secondaryVariant: '#29c',
        accent: '#EE3',
        danger: '#E90',
      };
      // This is a stupid thing that just generates a bunch of random keyframe transforms.
      const genFrames = (baseRotation) => {
        const filling = (min, max, items, digits) => {
          const x = [];
          const mul = Math.pow(10, digits);
          const div = Math.pow(10, -digits);
          for (let i = 0; i < items; i++) x[i] = Math.random();
          const t = x.reduce((s, v) => s + v, 0);
          return x.map(v => Math.round((v * (max - min) / t + min) * mul) / mul);
        };
        const keyframes = [];
        for (let i = 0; i < 100; i+= 5) {
          const [rotate, skewX, skewY] = filling(-5, 5, 3, 2);
          const [scaleX, scaleY] = filling(-0.25, 0.33, 2, 2);
          const [transX, transY] = filling(-3, 3, 2, 0);
          const transform = `transform: rotate(${baseRotation + rotate}deg) skew(${skewX}deg, ${skewY}deg) scale(${1+scaleX}, ${1+scaleY}) translate(${transX}px, ${transY}px);`
          if (i === 0) {
            keyframes.push(`100% { ${transform} }`);
          }
          keyframes.push(`${i}% { ${transform} }`);
        }
        // Move `100%` to the end
        keyframes.push(keyframes.shift());
        return keyframes.join('\n');
      }
      const styles = css`
        html, body {
          background-color: ${theme.background};
          color: ${theme.primary};
          font-family: sans-serif;
        }
        .demo {
          width: 50vw;
          margin: 0 auto;
          padding-top: 2rem;
          text-align: center;
        }
        .button {
          border: none;
          background: ${theme.secondary};
          padding: 10px;
          border-radius: calc(10px + 1.6em);
        }
        .button:focus {
          outline: none;
        }
        .button:active {
          background: ${theme.secondaryVariant};
          color: ${theme.primaryVariant};
        }
        .button:hover {
          background: ${theme.secondaryVariant};
        }
        a, a:link, a:visited {
          position: relative;
          color: white;
        }
        a.buildless {
          text-decoration: none;
        }
        a.buildless:hover:before, a.buildless:hover:after {
          animation-duration: 1s;
        }
        a.buildless:before, a.buildless:after {
          color: white;
          position: absolute;
          text-decoration: none;
          top: -0.75em;
          font-size: 0.6em;
          text-shadow: 0 0 2px ${theme.accent}, 0 0 5px ${theme.accent};
          animation: 40s cubic-bezier(0.25, 0.5, 0.75, 0.5) -5s infinite;
        }
        a.buildless:before {
          content: '✧･ﾟ:*✧･ﾟ:*';
          left: 0.5em;
          transform: rotate(-10deg);
          animation-name: wiggle-left !important;
        }
        a.buildless:after {
          content: '*:･ﾟ✧*:･ﾟ✧';
          right: 0.5em;
          transform: rotate(10deg);
          animation-name: wiggle-right !important;
        }
        @keyframes wiggle-left { ${genFrames(-10)} }
        @keyframes wiggle-right { ${genFrames(10)} }
      `;

      const ClickCounter = () => {
        const [count, setCount] = useState(0);
        return html`
          <button className=${styles.button} onClick=${() => setCount(count + 1)}>
            Clicked ${count} times
          </button>
        `;
      };

      const ExtLink = ({ children, ...props }) => html`
        <a
          target="_blank"
          rel="noopener noreferrer"
          ...${props}
        >
          ${children}
        </a>
      `;

      // Here's a dumb little ToDo list
      const todoStyles = css`
        .todoList {}
        .todoList .todo:nth-of-type(2n) {
          background: ${theme.backgroundVariant};
        }
        .todo {
          display: flex;
          flex-direction: row;
        }
        .todo input[type="text"] {
          border: none;
          background: none;
          color: ${theme.primary};
          flex: 1 1 auto;
        }
        .todo input[type="text"][disabled] {
          text-decoration: line-through;
        }
        .todo input[type="checkbox"] {
          margin: 10px 3px 0;
        }
        .smallButton {
          width: 29px;
          height: 29px;
          box-sizing: border-box;
          overflow: hidden;
          color: transparent;
          background: ${theme.secondary};
          border: none;
          border-radius: 15px;
          margin: 3px;
          position: relative;
        }
        .smallButton:before {
          color: white;
          left: 0;
          top: 0;
          line-height: 30px;
          font-weight: bold;
          position: absolute;
          width: 100%;
          height: 100%;
          text-align: center;
        }
        .smallButton.removeTodo {
          background: ${theme.danger};
        }
        .removeTodo:before {
          content: '+';
          font-size: 1.6em;
          transform: rotate(45deg);
        }
        .addTodo:before {
          content: '+';
          font-size: 1.6em;
        }
      `;

      const ToDo = ({ item, update, remove }) => {
        const { todo, smallButton, removeTodo } = todoStyles;
        const updateDone = ({ target }) => update(item, { done: target.checked });
        const updateContent = ({ target }) => update(item, { content: target.value });
        const removeSelf = () => remove(item);
        return html`
          <div className=${todo}>
            <input type="checkbox" checked=${item.done} onChange=${updateDone} />
            <input type="text" value=${item.content} disabled=${item.done} onChange=${updateContent} />
            <button className=${smallButton.and(removeTodo)} onClick=${removeSelf}>Remove</button>
          </div>
        `;
      };
      const defaultList = [
        { done: true, content: 'Write a ToDo list' },
        { done: false, content: 'Do something cool' },
      ];
      const ToDoList = () => {
        const [todoList, setToDoList] = useState(JSON.parse(localStorage.getItem('todo-list') || JSON.stringify(defaultList)));
        const { smallButton, addTodo, clearComplete } = todoStyles;
        useEffect(() => {
          localStorage.setItem('todo-list', JSON.stringify(todoList));
        }, [todoList]);
        const update = (item, updates) => {
          const tmp = todoList.slice();
          tmp.splice(todoList.indexOf(item), 1, { ...item, ...updates });
          setToDoList(tmp);

        };
        const remove = (item) => {
          const tmp = todoList.slice();
          tmp.splice(todoList.indexOf(item), 1);
          setToDoList(tmp);
        };
        const add = () => {
          setToDoList(todoList.concat([{ content: '', done: false }]));
        };
        const clear = () => {
          setToDoList(todoList.filter(item => !item.done));
        };
        const clearDisabled = !todoList.find(item => item.done);
        return html`
          <div class=${todoStyles.todoList}>
            ${todoList.map(item => html`<${ToDo} item=${item} update=${update} remove=${remove} />`)}
            <button className=${smallButton.and(addTodo)} onClick=${add}>Add</button>
            <button className=${styles.button.and(clearComplete)} onClick=${clear} disabled=${clearDisabled}>Clear complete</button>
          </div>
        `;
      };

      const BuildlessLink = () => html`<${ExtLink} className=${styles.buildless} href="https://github.com/Fordi/buildless">Buildless<//>`;
      const PreactLink = () => html`<${ExtLink} href="https://preactjs.com/">Preact<//>`;
      const HtmLink = () => html`<${ExtLink} href="https://github.com/developit/htm">HTM<//>`;
      const PortfolioLink = () => html`<${ExtLink} href="https://github.com/Fordi/fordi-org">portfolio site<//>`;

      const App = () => html`
        <div className=${styles.demo}>
          <p>
            This is a simple demo app for <${BuildlessLink} />.
          </p>
          <p>
            Buildless is a tiny (6k) compilation of <${PreactLink} /> and <${HtmLink} /> that
            allows you to write modern web applications with little-to-no framework, and without a compilation
            step.
          </p>
          <p>
            The goal here is that you should be able to create apps whose source runs directly
            in the browser - just like the olden days - but which take can take full advantage
            of JavaScript features that modern browsers now ubiquitously support.
          </p>
          <p>
            Have a look at this page's source to understand.  Everything you see here is in human-readable source,
            served directly from a single HTML page.  For a more complex example, you can check
            my <${PortfolioLink} />.
          </p>
          <p>
            Meanwhile, click this button: <${ClickCounter} />
          </p>
          <p>
            Note: There's no need for the source to all be on this page; it's only like
            this for the benefit of devs looking to get a handle
            on Buildless at a glance.
          </p>
          <p>
            A ToDo list, since no JS tooling is complete without one.
          </p>
          <${ToDoList} />
        </div>
      `;

      render(html`<${App}/>`, document.getElementById('app'));
    </script>
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>
