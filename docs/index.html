<!DOCTYPE html>
<html>
  <head>
    <title>Buildless demo</title>
    <script type="module">
      import { render, useState, useEffect, html, css } from 'https://unpkg.com/@fordi-org/buildless';
      const theme = {
        background: '#333',
        backgroundVariant: '#222',
        primary: '#EEE',
        primaryVariant: '#FFF',
        secondary: '#2cf',
        secondaryVariant: '#29c',
        accent: '#EE3',
        danger: '#E90',
      };
      // This is a stupid thing that just generates a bunch of random keyframe transforms.
      const genFrames = (baseRotation) => {
        const filling = (min, max, items, digits) => {
          const x = [];
          const mul = Math.pow(10, digits);
          const div = Math.pow(10, -digits);
          for (let i = 0; i < items; i++) x[i] = Math.random();
          const t = x.reduce((s, v) => s + v, 0);
          return x.map(v => Math.round((v * (max - min) / t + min) * mul) / mul);
        };
        const keyframes = [];
        for (let i = 0; i < 100; i+= 5) {
          const [rotate, skewX, skewY] = filling(-5, 5, 3, 2);
          const [scaleX, scaleY] = filling(-0.25, 0.33, 2, 2);
          const [transX, transY] = filling(-3, 3, 2, 0);
          const transform = `transform: rotate(${baseRotation + rotate}deg) skew(${skewX}deg, ${skewY}deg) scale(${1+scaleX}, ${1+scaleY}) translate(${transX}px, ${transY}px);`
          if (i === 0) {
            keyframes.push(`100% { ${transform} }`);
          }
          keyframes.push(`${i}% { ${transform} }`);
        }
        // Move `100%` to the end
        keyframes.push(keyframes.shift());
        return keyframes.join('\n');
      }
      const styles = css`
        html, body {
          background-color: ${theme.background};
          color: ${theme.primary};
          font-family: sans-serif;
        }
        .demo {
          width: 50vw;
          margin: 0 auto;
          padding-top: 2rem;
          text-align: center;
        }
        .button {
          border: none;
          background: ${theme.secondary};
          padding: 10px;
          border-radius: calc(10px + 1.6em);
        }
        .button:focus {
          outline: none;
        }
        .button:active {
          background: ${theme.secondaryVariant};
          color: ${theme.primaryVariant};
        }
        .button:hover {
          background: ${theme.secondaryVariant};
        }
        a, a:link, a:visited {
          position: relative;
          color: white;
          text-decoration: none;
        }
        a:hover:before, a:hover:after {
          animation-duration: 1s;
        }
        a:before, a:after {
          color: white;
          position: absolute;
          text-decoration: none;
          top: -0.75em;
          font-size: 0.6em;
          text-shadow: 0 0 2px ${theme.accent}, 0 0 5px ${theme.accent};
          animation: 40s cubic-bezier(0.25, 0.5, 0.75, 0.5) -5s infinite;
        }
        a:before {
          content: '✧･ﾟ:*✧･ﾟ:*';
          left: 0.5em;
          transform: rotate(-10deg);
          animation-name: wiggle-left !important;
        }
        a:after {
          content: '*:･ﾟ✧*:･ﾟ✧';
          right: 0.5em;
          transform: rotate(10deg);
          animation-name: wiggle-right !important;
        }
        @keyframes wiggle-left { ${genFrames(-10)} }
        @keyframes wiggle-right { ${genFrames(10)} }
      `;

      const ClickCounter = () => {
        const [count, setCount] = useState(0);
        return html`
          <button className=${styles.button} onClick=${() => setCount(count + 1)}>
            Clicked ${count} times
          </button>
        `;
      };

      const ExtLink = ({ children, ...props }) => html`
        <a
          target="_blank"
          rel="noopener noreferrer"
          ...${props}
        >
          ${children}
        </a>
      `;

      const todoStyles = css`
        .todoList {

        }
        .todoList .todo:nth-of-type(2n) {
          background: ${theme.backgroundVariant};
        }
        .todo {
          display: flex;
          flex-direction: row;
        }
        .todo input[type="text"] {
          border: none;
          background: none;
          color: ${theme.primary};
          flex: 1 1 auto;
        }
        .todo input[type="text"][disabled] {
          text-decoration: line-through;
        }
        .todo input[type="checkbox"] {
          margin: 10px 3px 0;
        }
        .smallButton {
          width: 29px;
          height: 29px;
          box-sizing: border-box;
          overflow: hidden;
          color: transparent;
          background: ${theme.secondary};
          border: none;
          border-radius: 15px;
          margin: 3px;
          position: relative;
        }
        .smallButton:before {
          color: white;
          left: 0;
          top: 0;
          line-height: 30px;
          font-weight: bold;
          position: absolute;
          width: 100%;
          height: 100%;
          text-align: center;
        }
        .smallButton.removeTodo {
          background: ${theme.danger};
        }
        .removeTodo:before {
          content: '+';
          font-size: 1.6em;
          transform: rotate(45deg);
        }
        .addTodo:before {
          content: '+';
          font-size: 1.6em;
        }
      `;

      const ToDo = ({ item, update, remove }) => {
        return html`
          <div className=${todoStyles.todo}>
            <input type="checkbox" onChange=${({ target }) => update(item, { done: target.checked })} checked=${item.done} />
            <input type="text" disabled=${item.done} value=${item.content} onChange=${({ target }) => update(item, { content: target.value })} />
            <button className=${todoStyles.smallButton.and(todoStyles.removeTodo)} onClick=${() => remove(item)}>Remove</button>
          </div>
        `;
      };
      const defaultList = [
        { done: true, content: 'Write a ToDo list' },
        { done: false, content: 'Do something cool' },
      ];
      const ToDoList = () => {
        const [todoList, setToDoList] = useState(JSON.parse(localStorage.getItem('todo-list') || JSON.stringify(defaultList)));
        useEffect(() => {
          localStorage.setItem('todo-list', JSON.stringify(todoList));
        }, [todoList]);
        const update = (item, updates) => {
          const tmp = todoList.slice();
          tmp.splice(todoList.indexOf(item), 1, { ...item, ...updates });
          setToDoList(tmp);

        };
        const remove = (item) => {
          const tmp = todoList.slice();
          tmp.splice(todoList.indexOf(item), 1);
          setToDoList(tmp);
        };
        const add = () => {
          setToDoList(todoList.concat([{ content: '', done: false }]));
        };
        const clearComplete = () => {
          setToDoList(todoList.filter(item => !item.done));
        };
        return html`
          <div class=${todoStyles.todoList}>
            ${todoList.map(item => html`<${ToDo} item=${item} update=${update} remove=${remove} />`)}
            <button className=${todoStyles.smallButton.and(todoStyles.addTodo)} onClick=${add}>Add</button>
            <button className=${styles.button.and(todoStyles.clearComplete)} onClick=${clearComplete} disabled=${!todoList.find(item => item.done)}>Clear complete</button>
          </div>
        `;
      };

      const App = () => html`
        <div className=${styles.demo}>
          <p>
            This is a simple demo app for <${ExtLink} href="https://github.com/Fordi/buildless">Buildless<//>.
          </p>
          <p>
            Have a look at this page's source to understand.
          </p>
          <p>
            Meanwhile, click this button: <${ClickCounter}/>
          </p>
          <p>
            Note: There's no need for the source to all be on this page; it's only like
            this for the benefit of devs looking to get a handle
            on <${ExtLink} href="https://github.com/Fordi/buildless">Buildless<//> at a glance.
          </p>
          <p>
            A ToDo list, since no JS framework is complete without one.
          </p>
          <${ToDoList} />
        </div>
      `;

      render(html`<${App}/>`, document.getElementById('app'));
    </script>
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>
